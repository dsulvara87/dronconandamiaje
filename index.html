<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plataforma STEM: Dron Guardi√°n de los Cerros</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
                /* ARCHIVO CORREGIDO Y FUSIONADO (v3)
          ===============================
          Correcci√≥n del bug "Girar Izquierda" y "Girar Derecha" en la FASE 2.
        */

                /* Variables y Paleta de Colores de 'gamificacion' */
                :root {
                    --bg-deep: #1A1A2E;
                    --bg-medium: #16213E;
                    --panel-bg: #2C394B;
                    --primary-blue: #00ADB5;
                    --secondary-yellow: #FFC947;
                    --text-light: #EEEEEE;
                    --text-dark: #121212;
                    --accent-green: #6EEB83;
                    --accent-red: #FF416C;
                    --border-soft: 1px solid rgba(255, 255, 255, 0.1);
                    --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.3);
                }

                body {
                    font-family: 'Roboto Condensed', sans-serif;
                    margin: 0;
                    background: linear-gradient(135deg, #0A1128, var(--bg-deep));
                    color: var(--text-light);
                    line-height: 1.6;
                    min-height: 100vh;
                }

                .view {
                    display: none;
                    width: 100%;
                    min-height: 100vh;
                    animation: fadeIn 0.5s ease;
                }

                    .view.active {
                        display: block;
                    }

                h1, h2, h3, h4 {
                    font-family: 'Orbitron', sans-serif;
                    color: var(--primary-blue);
                }

                h1 {
                    font-size: 1.8rem;
                }

                h2 {
                    font-size: 1.4rem;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                    padding-bottom: 8px;
                    margin-bottom: 15px;
                }

                button {
                    font-family: 'Roboto Condensed', sans-serif;
                    font-weight: 700;
                    cursor: pointer;
                    border: none;
                    border-radius: 8px;
                    padding: 12px 20px;
                    font-size: 1.05em;
                    transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
                    color: var(--text-dark);
                }

                    button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 15px rgba(0,0,0,0.4);
                    }

                    button:disabled {
                        background-color: #555 !important;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                        opacity: 0.7;
                    }

                .panel-container {
                    background: var(--panel-bg);
                    padding: 20px;
                    border-radius: 12px;
                    box-shadow: var(--shadow-soft);
                    border: var(--border-soft);
                }

                /* FASE 0: BRIEFING (Sin cambios) */
                #briefing-view {
                    padding: 20px;
                    max-width: 1000px;
                    margin: auto;
                }

                .briefing-section {
                    background: var(--bg-medium);
                    padding: 25px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: var(--border-soft);
                }

                .accordion-item button {
                    width: 100%;
                    background: var(--bg-deep);
                    color: var(--text-light);
                    padding: 15px;
                    font-size: 1.1em;
                    text-align: left;
                    margin-top: 10px;
                    border: var(--border-soft);
                }

                .accordion-content {
                    display: none;
                    padding: 15px;
                    background: var(--bg-deep);
                    border-radius: 0 0 8px 8px;
                    border: var(--border-soft);
                    border-top: none;
                    animation: fadeIn 0.5s;
                }

                #proceed-to-workshop-btn {
                    background-color: var(--accent-green);
                    width: 100%;
                    margin-top: 25px;
                }

                .academic-goals {
                    list-style-type: none;
                    padding: 0;
                    margin-top: 15px;
                }

                    .academic-goals li {
                        margin-bottom: 8px;
                        border-left: 3px solid var(--secondary-yellow);
                        padding-left: 10px;
                    }

                /* FASE 1: TALLER DE DISE√ëO (Sin cambios) */
                #workshop-view {
                    padding: 20px;
                    max-width: 1400px;
                    margin: auto;
                }

                .workshop-layout {
                    display: grid;
                    grid-template-columns: 350px 1fr;
                    gap: 25px;
                }

                .design-info {
                    background: var(--bg-medium);
                    padding: 20px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border: var(--border-soft);
                }

                .design-stats-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px 0;
                    border-bottom: 1px dashed rgba(255,255,255,0.1);
                    font-size: 1em;
                }

                    .design-stats-item span:first-child {
                        color: var(--primary-blue);
                    }

                .assembly-hangar {
                    min-height: 450px;
                    background: var(--bg-medium);
                    padding: 20px;
                    border-radius: 12px;
                    position: relative;
                }

                #parts-list-hangar {
                    max-height: 250px;
                    overflow-y: auto;
                    padding-right: 10px;
                }

                .part-piece-item {
                    background: var(--bg-deep);
                    color: var(--text-light);
                    padding: 10px;
                    margin-bottom: 10px;
                    border-radius: 6px;
                    border-left: 5px solid var(--primary-blue);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: pointer;
                }

                .part-piece-visual {
                    cursor: grab;
                    background: var(--secondary-yellow);
                    width: 25px;
                    height: 25px;
                    border-radius: 4px;
                    display: inline-block;
                    transition: opacity 0.2s;
                }

                    .part-piece-visual.assembled {
                        cursor: default;
                        opacity: 0.3;
                        background: var(--accent-green);
                    }

                .hologram-container {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%,-50%);
                    width: 300px;
                    height: 200px;
                }

                .hologram-slot {
                    position: absolute;
                    border: 2px dashed rgba(0,173,181,0.4);
                    border-radius: 8px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    color: var(--text-light);
                    font-size: 0.8em;
                    transition: all 0.2s;
                    cursor: pointer;
                }

                    .hologram-slot.over-correct {
                        background-color: rgba(110,235,131,0.3);
                        border-color: var(--accent-green);
                    }

                    .hologram-slot.assembled {
                        background-color: var(--primary-blue);
                        border-color: var(--primary-blue);
                        color: var(--text-light);
                    }

                #hypothesis-box {
                    height: 200px;
                    width: 100%;
                    background: var(--bg-deep);
                    border-radius: 8px;
                    padding: 15px;
                    color: var(--text-light);
                    border: 1px solid var(--secondary-yellow);
                }

                    #hypothesis-box textarea {
                        width: 100%;
                        height: 80%;
                        background: rgba(255,255,255,0.05);
                        border: none;
                        padding: 10px;
                        color: var(--text-light);
                        resize: none;
                        border-radius: 5px;
                    }

                #start-simulation-btn {
                    background-color: var(--accent-green);
                    color: var(--text-dark);
                }

                /* FASE 2: SIMULACI√ìN (CSS de '1. programacion.html' adaptado) */
                #simulation-view {
                    display: grid;
                    grid-template-columns: 340px auto 380px;
                    font-family: 'Roboto Condensed', sans-serif;
                    margin: 0;
                    height: 100vh;
                    gap: 10px;
                    padding: 10px;
                    box-sizing: border-box;
                }

                #sim-panel-left, #sim-panel-right-stem {
                    background: var(--bg-medium);
                    color: var(--text-light);
                    padding: 15px;
                    overflow-y: auto;
                    border-radius: 12px;
                    border: var(--border-soft);
                }

                #sim-board-container {
                    display: grid;
                    grid-template-columns: 40px auto;
                    grid-template-rows: 40px auto;
                    background: var(--bg-medium);
                    padding: 15px;
                    border-radius: 12px;
                }

                #col-labels, #row-labels {
                    display: grid;
                    align-items: center;
                    justify-items: center;
                    background: #0096c7;
                    color: var(--text-light);
                    font-weight: bold;
                }

                #workspace {
                    display: grid;
                    border: 3px solid var(--primary-blue);
                    background: #0d1622;
                }

                .cell {
                    border: 1px solid rgba(255,255,255,0.1);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 20px;
                    font-weight: bold;
                    min-width: 40px;
                    min-height: 40px;
                    aspect-ratio: 1 / 1;
                }

                    .cell:nth-child(even) {
                        background: #16213E;
                    }

                .dron {
                    color: #495057;
                }

                .lake {
                    color: #0077b6;
                }

                .fire {
                    color: #d00000;
                }

                .apagado {
                    color: #6c757d;
                }

                .block {
                    padding: 8px;
                    margin: 5px;
                    background: var(--primary-blue);
                    color: var(--text-dark);
                    text-align: center;
                    cursor: grab;
                    border-radius: 5px;
                    font-weight: bold;
                }

                #program {
                    min-height: 200px;
                    border: 2px dashed rgba(255,255,255,0.3);
                    margin-top: 10px;
                    padding: 10px;
                    background: var(--bg-deep);
                    border-radius: 8px;
                }

                #status {
                    margin-top: 10px;
                    font-weight: bold;
                }

                #battery-container {
                    width: 100%;
                    height: 20px;
                    background: #ccc;
                    border-radius: 5px;
                    margin-top: 10px;
                    overflow: hidden;
                }

                #battery-bar {
                    height: 100%;
                    width: 100%;
                    background: var(--accent-green);
                    transition: width 0.5s linear, background 0.5s linear;
                }

                #vidas {
                    margin-top: 10px;
                    font-weight: bold;
                    color: var(--accent-red);
                }

                .sim-btn {
                    margin: 5px 2px;
                    padding: 8px 15px;
                    border-radius: 5px;
                    font-weight: bold;
                    font-size: 0.9em;
                }

                .btn-del {
                    background: var(--accent-red);
                    color: white;
                }

                .btn-clear {
                    background: var(--secondary-yellow);
                    color: var(--text-dark);
                }

                .btn-run {
                    background: var(--accent-green);
                    color: var(--text-dark);
                }

                .btn-reset {
                    background: var(--primary-blue);
                    color: var(--text-dark);
                }

                h3, h4 {
                    color: var(--primary-blue);
                }

                #menuSTEM button {
                    width: 100%;
                    margin: 5px 0;
                    background: var(--panel-bg);
                    color: white;
                    border: var(--border-soft);
                    border-radius: 5px;
                    padding: 8px;
                    font-weight: bold;
                    cursor: pointer;
                }

                    #menuSTEM button:hover {
                        background: var(--primary-blue);
                        color: var(--text-dark);
                    }

                #contenidoSTEM {
                    margin-top: 15px;
                    background: var(--bg-deep);
                    border-radius: 8px;
                    padding: 10px;
                    font-size: 14px;
                    text-align: justify;
                }

                #explicacionSimulador {
                    background: var(--bg-medium);
                    border: 1px solid var(--primary-blue);
                    border-radius: 8px;
                    padding: 10px;
                    margin-bottom: 15px;
                    font-size: 14px;
                    text-align: justify;
                }

                /* FASE 3: RESULTADOS (Informe Final Corregido) */
                #results-view {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                    text-align: left;
                }

                .results-card {
                    background: var(--bg-medium);
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: var(--shadow-soft);
                    max-width: 800px;
                    border: var(--border-soft);
                }

                .stat-result-box {
                    padding: 15px;
                    border-radius: 8px;
                    background: var(--bg-deep);
                    margin-bottom: 10px;
                    border-left: 4px solid var(--primary-blue);
                    font-size: 1.1em;
                }

                    .stat-result-box strong {
                        color: var(--secondary-yellow);
                    }

                .new-prototype-btn {
                    background-color: var(--primary-blue);
                    margin-top: 25px;
                }

                #reflection-box {
                    background: var(--bg-deep);
                    border-radius: 8px;
                    padding: 15px;
                    color: var(--text-light);
                    border: 1px solid var(--secondary-yellow);
                    margin-top: 20px;
                }

                    #reflection-box textarea {
                        width: 95%;
                        height: 120px;
                        background: rgba(255,255,255,0.05);
                        border: none;
                        padding: 10px;
                        color: var(--text-light);
                        resize: none;
                        border-radius: 5px;
                        font-family: 'Roboto Condensed', sans-serif;
                        font-size: 1em;
                    }

                @media (max-width: 1100px) {
                    .workshop-layout {
                        grid-template-columns: 1fr;
                    }

                    #simulation-view {
                        grid-template-columns: 1fr;
                        grid-template-rows: auto 1fr auto;
                        height: auto;
                    }

                    #sim-board-container {
                        order: 1;
                    }

                    #sim-panel-left {
                        order: 2;
                    }

                    #sim-panel-right-stem {
                        order: 3;
                    }

                    #workspace {
                        width: 90%;
                        margin: 10px auto;
                    }

                    .cell {
                        min-width: 25px;
                        min-height: 25px;
                    }
                }

                @keyframes fadeIn {
                    from {
                        opacity: 0;
                    }

                    to {
                        opacity: 1;
                    }
                }
    </style>
</head>
<body>
    <div id="briefing-view" class="view"></div>
    <div id="workshop-view" class="view"></div>
    <div id="simulation-view" class="view"></div>
    <div id="results-view" class="view"></div>

    <script>document.addEventListener('DOMContentLoaded', () => {

            // ---------------------------
            // DATOS GLOBALES Y COMPONENTES (del Taller)
            // ---------------------------
            const components = {
                chassis: [
                    { id: 'c1', name: 'Chasis Ligero (12kg)', type: 'chassis', cost: 1500, weight: 12, capacityFactor: 1, research: 'Ideal para la agilidad; capacidad de carga limitada.' },
                    { id: 'c2', name: 'Chasis Pesado (25kg)', type: 'chassis', cost: 2500, weight: 25, capacityFactor: 2, research: 'Permite llevar m√°s agente qu√≠mico y bater√≠as m√°s grandes, pero consume m√°s energ√≠a por su peso.' }
                ],
                motors: [
                    { id: 'm1', name: 'Motores Est√°ndar', type: 'motors', cost: 2000, consumption: 15, research: 'Opci√≥n balanceada. Consumo est√°ndar por movimiento.' },
                    { id: 'm2', name: 'Motores Alto Rendimiento', type: 'motors', cost: 3500, consumption: 10, research: 'Optimizado para grandes altitudes, reduce consumo por movimiento.' }
                ],
                sensors: [
                    { id: 's1', name: 'Termogr√°fico Est√°ndar', type: 'sensors', cost: 1000, efficiencyPenaltyFactor: 1.5, research: 'Mayor penalizaci√≥n en terreno dif√≠cil.' },
                    { id: 's2', name: 'LIDAR + Termogr√°fico', type: 'sensors', cost: 3000, efficiencyPenaltyFactor: 0.8, research: 'Mejor optimizaci√≥n de rutas en terreno escarpado.' }
                ],
                battery: [
                    { id: 'b1', name: 'Bater√≠a Est√°ndar (100u)', type: 'battery', cost: 1000, capacity: 100, research: 'Capacidad base.' },
                    { id: 'b2', name: 'Bater√≠a Larga Duraci√≥n (200u)', type: 'battery', cost: 2000, capacity: 200, research: 'Duplica la autonom√≠a.' }
                ]
            };

            let assembledConfig = {};

            const specificSlots = {
                'chassis-dropzone': { type: 'chassis', slotId: 'chassis', label: 'CHASIS' },
                'sensor-dropzone': { type: 'sensors', slotId: 'sensors', label: 'SENSOR' },
                'battery-dropzone': { type: 'battery', slotId: 'battery', label: 'BATER√çA' },
                'motor-dropzone-L': { type: 'motors', slotId: 'motorL', label: 'MOTOR L' },
                'motor-dropzone-R': { type: 'motors', slotId: 'motorR', label: 'MOTOR R' }
            };
            const requiredPartTypes = ['chassis', 'motorL', 'motorR', 'sensors', 'battery'];

            // ---------------------------
            // NAVEGACI√ìN
            // ---------------------------
            function transitionToView(viewId, data) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                const view = document.getElementById(viewId);
                if (!view) {
                    console.error("Vista no encontrada:", viewId);
                    return;
                }
                view.classList.add('active');

                if (viewId === 'briefing-view') {
                    briefing.init();
                } else if (viewId === 'workshop-view') {
                    workshop.init();
                } else if (viewId === 'simulation-view') {
                    if (!document.getElementById('workspace')) {
                        renderFunctionalSimulator();
                    }
                    generateGrid();
                } else if (viewId === 'results-view') {
                    showFinalResults(data);
                }
            }

            function getComponentById(id) {
                for (const key in components) {
                    const found = components[key].find(c => c.id === id);
                    if (found) return found;
                }
                return null;
            }

            // ---------------------------
            // FASE 0: BRIEFING (Sin cambios)
            // ---------------------------
            const briefing = {
                init() {
                    const view = document.getElementById('briefing-view');
                    view.innerHTML = `
            <div class="panel-container">
              <div class="briefing-section">
                <h2>Pregunta Generadora: ¬øC√≥mo podemos dise√±ar un prototipo de dron de extinci√≥n de incendios que utilice sensores y herramientas para superar las dificultades que genera la altitud de Bogot√°?</h2>
              </div>
              <div class="briefing-section">
                <h2>Fundamentos y Contexto del Proyecto</h2>
                <p>Los Cerros Orientales enfrentan una amenaza cr√≠tica de incendios por sequ√≠a y especies inflamables. La topograf√≠a escarpada dificulta el acceso. Dise√±a un <strong>dron aut√≥nomo de supresi√≥n de incendios</strong> eficiente en altitud (2,640 msnm).</p>
                <ul class="academic-goals">
                  <h4>Objetivos:</h4>
                  <li><strong>Proyecto:</strong> Prototipo de dron eficiente para extinci√≥n en gran altitud.</li>
                  <li><strong>Aprendizaje:</strong> Formular hip√≥tesis, analizar consumo energ√©tico, optimizar trayectorias y evaluar desempe√±o.</li>
                </ul>
              </div>
              <button id="proceed-to-workshop-btn">Entendido, proceder al Taller de Dise√±o</button>
            </div>
          `;
                    document.getElementById('proceed-to-workshop-btn').onclick = () => transitionToView('workshop-view');
                }
            };

            // ---------------------------
            // FASE 1: TALLER DE DISE√ëO (Sin cambios)
            // ---------------------------
            const workshop = {
                init() {
                    assembledConfig = {};
                    const view = document.getElementById('workshop-view');
                    view.innerHTML = `
            <div style="text-align:center;"><h1>FASE 1: Hangar de Dise√±o y Ensamblaje</h1></div>
            <div class="workshop-layout">
              <div class="ws-left-panel">
                <div class="design-table panel-container">
                  <h2>1. Banco de Componentes</h2>
                  <p>Arrastra las piezas al dron o haz click para ensamblar. Tu elecci√≥n define la hip√≥tesis de dise√±o.</p>
                  <div id="parts-list-hangar"></div>
                </div>
                <div class="prototype-summary panel-container">
                  <h3>2. Modelado y Estad√≠sticas</h3>
                  <div id="prototype-stats"></div>
                </div>
                <div class="research-panel panel-container">
                  <h3>3. Hip√≥tesis y An√°lisis Cr√≠tico</h3>
                  <div id="hypothesis-box">
                    <p style="font-size:0.9em; margin-bottom:5px;">Plantea tu hip√≥tesis de dise√±o (m√≠nimo 50 caracteres).</p>
                    <textarea id="hypothesis-text" placeholder="Ej: Elijo el chasis pesado para aumentar la carga √∫til, confiando en motores de alto rendimiento y LIDAR."></textarea>
                  </div>
                  <p style="font-size:0.9em; color: var(--secondary-yellow); margin-top:10px;">Integra ciencia, matem√°ticas, tecnolog√≠a e ingenier√≠a en tu dise√±o.</p>
                </div>
              </div>

              <div class="ws-right-panel">
                <div class="panel-container assembly-hangar">
                  <h2>4. Estaci√≥n de Ensamblaje Hologr√°fico</h2>
                  <div class="hologram-container" id="hologram-area">
                    <svg id="holoSVG" width="300" height="200" viewBox="0 0 300 200" style="position:absolute; z-index:10;"></svg>
                    <div id="slot-container" style="position:absolute; width:100%; height:100%; z-index:20;"></div>
                  </div>
                </div>
                <button id="start-simulation-btn" disabled>Proceder a Prueba de Campo</button>
              </div>
            </div>
          `;
                    this.renderPartsList();
                    this.renderSlots();
                    this.addDragDropListeners();
                    this.updateStats();
                    this.updateHologramVisuals();

                    document.getElementById('start-simulation-btn').onclick = () => {
                        const hypothesis = document.getElementById('hypothesis-text').value || '';
                        if (hypothesis.length < 50) {
                            alert("Por favor, desarrolla tu hip√≥tesis (m√≠nimo 50 caracteres).");
                            return;
                        }
                        const finalConfig = this.calculateStats();
                        finalConfig.hypothesis = hypothesis;
                        transitionToView('simulation-view');
                    };
                },
                renderPartsList() {
                    const list = document.getElementById('parts-list-hangar');
                    list.innerHTML = '';
                    Object.values(components).flat().forEach(comp => {
                        const listItem = document.createElement('div');
                        listItem.id = `part-${comp.id}`;
                        listItem.className = 'part-piece-item';
                        listItem.innerHTML = `<span>${comp.name}</span><div class="part-piece-visual" draggable="true" data-part-id="${comp.id}" data-part-type="${comp.type}" title="Arrastrar o clickear"></div>`;
                        list.appendChild(listItem);
                    });
                },
                renderSlots() {
                    const container = document.getElementById('slot-container');
                    container.innerHTML = '';
                    const styles = {
                        'chassis-dropzone': 'top:75px; left:50%; transform:translate(-50%,-50%); width:200px; height:50px;',
                        'sensor-dropzone': 'top:15px; left:50%; transform:translateX(-50%); width:80px; height:30px;',
                        'battery-dropzone': 'top:145px; left:15px; width:80px; height:30px;',
                        'motor-dropzone-L': 'top:75px; left:10px; width:40px; height:40px;',
                        'motor-dropzone-R': 'top:75px; right:10px; width:40px; height:40px;'
                    };
                    Object.entries(specificSlots).forEach(([id, details]) => {
                        const div = document.createElement('div');
                        div.id = id;
                        div.className = 'hologram-slot';
                        div.dataset.partType = details.type;
                        div.dataset.slotId = details.slotId;
                        div.style = styles[id] || 'display:none;';
                        div.innerText = details.label;
                        container.appendChild(div);
                    });
                },
                addDragDropListeners() {
                    setTimeout(() => {
                        document.querySelectorAll('.part-piece-visual').forEach(p => {
                            p.addEventListener('dragstart', e => {
                                e.dataTransfer.setData('text/plain', e.target.dataset.partId);
                            });
                            p.addEventListener('click', (e) => {
                                const partId = e.target.dataset.partId;
                                this.quickPlacePart(partId);
                            });
                        });
                        document.querySelectorAll('.hologram-slot').forEach(zone => {
                            zone.addEventListener('dragover', e => {
                                e.preventDefault();
                                const draggingId = e.dataTransfer.getData('text/plain');
                                const draggingComp = getComponentById(draggingId);
                                if (draggingComp && draggingComp.type === zone.dataset.partType && !assembledConfig[zone.dataset.slotId]) {
                                    zone.classList.add('over-correct');
                                }
                            });
                            zone.addEventListener('dragleave', () => zone.classList.remove('over-correct'));
                            zone.addEventListener('drop', e => {
                                e.preventDefault();
                                zone.classList.remove('over-correct');
                                const partId = e.dataTransfer.getData('text/plain');
                                const slotId = zone.dataset.slotId;
                                if (assembledConfig[slotId]) return;
                                this.assemblePart(slotId, partId);
                            });
                            zone.addEventListener('click', () => {
                                const slotId = zone.dataset.slotId;
                                if (assembledConfig[slotId]) this.disassemblePart(slotId);
                            });
                        });
                    }, 0);
                },
                quickPlacePart(partId) {
                    const part = getComponentById(partId);
                    if (!part) return;
                    if (part.type === 'motors') {
                        if (!assembledConfig['motorL'] && !assembledConfig['motorR']) {
                            this.assemblePart('motorL', partId);
                        }
                    } else {
                        const slotEntry = Object.entries(specificSlots).find(([k, v]) => v.type === part.type && !assembledConfig[v.slotId]);
                        if (slotEntry) {
                            const slotId = slotEntry[1].slotId;
                            this.assemblePart(slotId, partId);
                        }
                    }
                },
                assemblePart(slotId, partId) {
                    const part = getComponentById(partId);
                    if (!part) return;
                    if (part.type === 'motors') {
                        assembledConfig['motorL'] = partId;
                        assembledConfig['motorR'] = partId;
                    } else {
                        assembledConfig[slotId] = partId;
                    }
                    this.updateHologramVisuals();
                    this.updateStats();
                    this.checkCompletion();
                },
                disassemblePart(slotId) {
                    if (slotId === 'motorL' || slotId === 'motorR') {
                        delete assembledConfig['motorL'];
                        delete assembledConfig['motorR'];
                    } else {
                        delete assembledConfig[slotId];
                    }
                    this.updateHologramVisuals();
                    this.updateStats();
                    this.checkCompletion();
                },
                updateHologramVisuals() {
                    const svg = document.getElementById('holoSVG');
                    if (!svg) return;
                    while (svg.firstChild) svg.removeChild(svg.firstChild);
                    const W = 300, H = 200, cx = W / 2, cy = H / 2;
                    const CHASSIS = getComponentById(assembledConfig.chassis);
                    const MOTORS = getComponentById(assembledConfig.motorL);
                    const SENSORS = getComponentById(assembledConfig.sensors);
                    const BATTERY = getComponentById(assembledConfig.battery);
                    const bodyW = CHASSIS ? (CHASSIS.id === 'c2' ? 150 : 100) : 80;
                    const bodyH = CHASSIS ? (CHASSIS.id === 'c2' ? 35 : 25) : 20;
                    if (CHASSIS) {
                        const rect = document.createElementNS(svg.namespaceURI, 'rect');
                        rect.setAttribute('x', cx - bodyW / 2); rect.setAttribute('y', cy - bodyH / 2);
                        rect.setAttribute('width', bodyW); rect.setAttribute('height', bodyH);
                        rect.setAttribute('fill', 'rgba(102,204,255,0.2)'); rect.setAttribute('stroke', '#00ADB5');
                        rect.setAttribute('stroke-width', '2'); rect.setAttribute('rx', '5');
                        svg.appendChild(rect);
                    }
                    if (MOTORS) {
                        const motorColor = MOTORS.id === 'm2' ? '#6EEB83' : '#FFC947';
                        const lineL = document.createElementNS(svg.namespaceURI, 'line');
                        lineL.setAttribute('x1', cx - bodyW / 2); lineL.setAttribute('y1', cy);
                        lineL.setAttribute('x2', cx - bodyW / 2 - 20); lineL.setAttribute('y2', cy);
                        lineL.setAttribute('stroke', motorColor); lineL.setAttribute('stroke-width', '2');
                        svg.appendChild(lineL);
                        const lineR = document.createElementNS(svg.namespaceURI, 'line');
                        lineR.setAttribute('x1', cx + bodyW / 2); lineR.setAttribute('y1', cy);
                        lineR.setAttribute('x2', cx + bodyW / 2 + 20); lineR.setAttribute('y2', cy);
                        lineR.setAttribute('stroke', motorColor); lineR.setAttribute('stroke-width', '2');
                        svg.appendChild(lineR);
                        const motorL = document.createElementNS(svg.namespaceURI, 'circle');
                        motorL.setAttribute('cx', cx - bodyW / 2 - 20); motorL.setAttribute('cy', cy);
                        motorL.setAttribute('r', 8); motorL.setAttribute('fill', motorColor);
                        svg.appendChild(motorL);
                        const motorR = document.createElementNS(svg.namespaceURI, 'circle');
                        motorR.setAttribute('cx', cx + bodyW / 2 + 20); motorR.setAttribute('cy', cy);
                        motorR.setAttribute('r', 8); motorR.setAttribute('fill', motorColor);
                        svg.appendChild(motorR);
                    }
                    if (SENSORS) {
                        const sensorColor = SENSORS.id === 's2' ? '#6EEB83' : '#FF416C';
                        const sensor = document.createElementNS(svg.namespaceURI, 'rect');
                        sensor.setAttribute('x', cx - 15); sensor.setAttribute('y', cy - bodyH / 2 - 15);
                        sensor.setAttribute('width', 30); sensor.setAttribute('height', 10);
                        sensor.setAttribute('fill', sensorColor);
                        svg.appendChild(sensor);
                    }
                    if (BATTERY) {
                        const battWidth = (BATTERY.capacity / 200) * 40 + 10;
                        const battery = document.createElementNS(svg.namespaceURI, 'rect');
                        battery.setAttribute('x', cx - bodyW / 2 - 50); battery.setAttribute('y', cy + 30);
                        battery.setAttribute('width', battWidth); battery.setAttribute('height', 15);
                        battery.setAttribute('fill', '#6EEB83'); battery.setAttribute('stroke', 'white');
                        svg.appendChild(battery);
                    }
                    document.querySelectorAll('.hologram-slot').forEach(zone => {
                        const slotId = zone.dataset.slotId;
                        zone.classList.remove('assembled');
                        zone.innerText = specificSlots[zone.id].label;
                        if (assembledConfig[slotId]) {
                            zone.classList.add('assembled');
                            const partInfo = getComponentById(assembledConfig[slotId]);
                            zone.innerText = `‚úÖ ${partInfo.id.toUpperCase()}`;
                        }
                    });
                },
                calculateStats() {
                    const CHASSIS = getComponentById(assembledConfig.chassis);
                    const MOTORS = getComponentById(assembledConfig.motorL);
                    const SENSORS = getComponentById(assembledConfig.sensors);
                    const BATTERY = getComponentById(assembledConfig.battery);
                    if (!CHASSIS || !MOTORS || !SENSORS || !BATTERY) {
                        return { cost: 0, maxBattery: 0, payloadCapacity: 0, consumption: 0, terrainPenaltyFactor: 0, configSnapshot: {} };
                    }
                    const baseWeight = 15;
                    const effectiveConsumptionPerMove = (MOTORS.consumption * (CHASSIS.weight / baseWeight)) * SENSORS.efficiencyPenaltyFactor;
                    const totalCost = CHASSIS.cost + MOTORS.cost + SENSORS.cost + BATTERY.cost;
                    return {
                        maxBattery: BATTERY.capacity,
                        payloadCapacity: CHASSIS.capacityFactor,
                        consumption: effectiveConsumptionPerMove,
                        cost: totalCost,
                        terrainPenaltyFactor: SENSORS.efficiencyPenaltyFactor,
                        configSnapshot: { chassis: CHASSIS.name, motors: MOTORS.name, sensors: SENSORS.name, battery: BATTERY.name }
                    };
                },
                updateStats() {
                    const stats = this.calculateStats();
                    const statsElement = document.getElementById('prototype-stats');
                    statsElement.innerHTML = `
            <h4><span style="color:var(--accent-green)">Rendimiento de Vuelo</span></h4>
            <div class="design-stats-item"><span>Capacidad de Bater√≠a:</span><span>${stats.maxBattery} u.</span></div>
            <div class="design-stats-item"><span>Carga de Agente:</span><span>${stats.payloadCapacity} u.</span></div>
            <div class="design-stats-item"><span>Consumo Estimado (Terreno Escarpado):</span><span style="color:${stats.consumption > 25 ? 'var(--accent-red)' : 'var(--accent-green)'};">${stats.consumption.toFixed(1)} u/mov</span></div>
            <div class="design-stats-item"><span>Costo Total:</span><span style="color:${stats.cost > 8000 ? 'var(--accent-red)' : 'var(--secondary-yellow)'};">$${stats.cost}</span></div>
            <p class="muted" style="font-size:0.9em; margin-top:15px;">El consumo real se deriva de la relaci√≥n Peso/Potencia y eficiencia del sensor.</p>
          `;
                },
                checkCompletion() {
                    const isComplete = requiredPartTypes.every(type => assembledConfig[type]);
                    document.getElementById('start-simulation-btn').disabled = !isComplete;
                }
            };

            // -----------------------------------------------------------------
            // FASE 2: SIMULADOR (L√≥gica de '1. programacion.html' insertada)
            // -----------------------------------------------------------------

            let program, workspace, colLabels, rowLabels, statusDiv, batteryBar, contenidoSTEM, vidasDiv;
            let bateria = 100, apagados = 0, water = false;
            let gridSize = 10, droneRow, droneCol;
            let vidas = 3;
            let bateriasAgotadas = 0;
            let totalFires = 0;
            let isSimRunning = false;

            const temas = {
                ciencia: `<h3>üî¨ Ciencia</h3><p>Los incendios forestales en los cerros orientales tienen causas naturales y humanas. La ciencia estudia sus efectos en aire, agua, suelo y biodiversidad.</p>`,
                tecnologia: `<h3>üíª Tecnolog√≠a</h3><p>La tecnolog√≠a aporta drones con c√°maras t√©rmicas, sat√©lites y apps de alerta temprana para vigilar y mitigar incendios.</p>`,
                ingenieria: `<h3>‚öôÔ∏è Ingenier√≠a</h3><p>La ingenier√≠a dise√±a cortafuegos, sistemas de riego y rutas √≥ptimas para brigadas y drones.</p>`,
                matematicas: `<h3>üìê Matem√°ticas</h3><p>Las matem√°ticas ayudan a calcular trayectorias, consumo de energ√≠a y probabilidades de riesgo de incendio.</p>`,
                ciudadania: `<h3>üå± Ciudadan√≠a</h3><p>La ciudadan√≠a puede prevenir incendios evitando fogatas, denunciando quemas y participando en campa√±as ambientales.</p>`,
                didactica: `<h3>üìò Unidad Did√°ctica: Incendios en los Cerros de Bogot√°</h3>
        <p><b>Duraci√≥n:</b> 80 minutos</p>
        <h4>üéØ Objetivos</h4>
        <ul>
          <li>Programar secuencias, bucles y condicionales en el simulador.</li>
          <li>Aplicar razonamiento matem√°tico para optimizar rutas y bater√≠a.</li>
          <li>Relacionar la tecnolog√≠a con la prevenci√≥n de incendios.</li>
          <li>Reflexionar sobre la prevenci√≥n y la acci√≥n ciudadana frente a problem√°ticas ambientales.</li>
        </ul>
        <h4>‚è±Ô∏è Secuencia de la sesi√≥n</h4>
        <ol>
          <li><b>Apertura (10 min):</b> Presentaci√≥n de la misi√≥n ‚ÄúSalvar los cerros de Bogot√° programando drones‚Äù.
              <i><a href="https://www.youtube.com/watch?v=0V2RCXRqD_8" target="_blank" title="Visualizaci√≥n de un video corto">Visualizaci√≥n de un video corto sobre los incendios en los cerros orientales </a></i></li>
          <li><b>Asignaci√≥n de roles en equipos (10 min): Piloto, Programador, Analista, Reporteros </i></li></b>
          <li><b>Exploraci√≥n guiada (15 min):</b> Conocer los bloques y probar el simulador.</li>
          <li><b>Reto 1 (15 min):</b> Programar el dron para apagar un incendio con instrucciones b√°sicas.</li>
          <li><b>Reto 2 (20 min):</b> Usar bucles y condiciones para optimizar la ruta y apagar todos los incendios.</li>
          <li><b>Cierre y reflexi√≥n (20 min):</b> Discusi√≥n grupal sobre estrategias, eficiencia del c√≥digo y relaci√≥n con drones reales.</li>
        </ol>
        <h4>‚úÖ Evaluaci√≥n</h4>
        <ul>
          <li>Incendios apagados con el c√≥digo programado.</li>
          <li>Uso de estructuras de control (bucles y condicionales).</li>
          <li>Participaci√≥n en el dise√±o de la estrategia.</li>
          <li>Reflexi√≥n escrita breve: ¬øC√≥mo se relaciona la programaci√≥n con la prevenci√≥n real de incendios en los cerros orientales?</li>
        </ul>`,
            };

            function renderFunctionalSimulator() {
                const view = document.getElementById('simulation-view');
                view.innerHTML = `
          <div id="sim-panel-left">
            <h2>üöÅ Programaci√≥n del Dron</h2>
            <h3>Bloques</h3>
            <div class="block" draggable="true">Iniciar programa</div>
            <div class="block" draggable="true">Avanzar</div>
            <div class="block" draggable="true">Subir</div>
            <div class="block" draggable="true">Bajar</div>
            <div class="block" draggable="true">Girar derecha</div>
            <div class="block" draggable="true">Girar izquierda</div>
            <div class="block" draggable="true">Recoger agua</div>
            <div class="block" draggable="true">Descargar agua</div>
            <div class="block" draggable="true">Repetir</div>
            <div class="block" draggable="true">Si hay fuego</div>

            <button class="sim-btn btn-run" id="run-sim-program">‚ñ∂ Ejecutar</button>
            <button class="sim-btn btn-del" id="delete-last-block">üóë Borrar √∫ltimo</button>
            <button class="sim-btn btn-clear" id="clear-program">üßπ Borrar todo</button>
            <button class="sim-btn btn-reset" id="reset-board">üîÑ Reiniciar tablero</button>

            <div id="program" ondragover="event.preventDefault()" ondrop="drop(event)">
              Arrastra aqu√≠ tus bloques
            </div>

            <div id="status">Incendios apagados: 0</div>
            <div id="battery-container">
              <div id="battery-bar"></div>
            </div>
            <div id="vidas">Bater√≠as restantes: 3 | Bater√≠as agotadas: 0</div>
          </div>
          <div id="sim-board-container">
            <div></div>
            <div id="col-labels"></div>
            <div id="row-labels">D</div>
            <div id="workspace"></div>
          </div>
          <div id="sim-panel-right-stem">
            <h2>‚ÑπÔ∏è Explicaci√≥n del simulador</h2>
            <div id="explicacionSimulador">
              Este simulador te permite programar un <b>dron virtual</b> para apagar incendios.
              <ul>
                <li>El dron inicia en la parte inferior del tablero.</li>
                <li>Debes arrastrar bloques de programaci√≥n al √°rea de instrucciones.</li>
                <li>El dron puede moverse, recoger agua en los lagos üíß y apagar incendios üî•.</li>
                <li>El reto consiste en apagar todos los incendios antes de que se agote la bater√≠a.</li>
              </ul>
              <b>Nota:</b> Tienes 3 bater√≠as por partida. Si las agotas todas, la misi√≥n falla.
            </div>

            <h2>üìö Temas STEM</h2>
            <div id="menuSTEM">
              <button onclick="mostrarTema('ciencia')">üî¨ Ciencia</button>
              <button onclick="mostrarTema('tecnologia')">üíª Tecnolog√≠a</button>
              <button onclick="mostrarTema('ingenieria')">‚öôÔ∏è Ingenier√≠a</button>
              <button onclick="mostrarTema('matematicas')">üìê Matem√°ticas</button>
              <button onclick="mostrarTema('ciudadania')">üå± Ciudadan√≠a</button>
              <button onclick="mostrarTema('didactica')">üìò Unidad Did√°ctica</button>
            </div>
            <div id="contenidoSTEM">
              Selecciona un tema para aprender c√≥mo los incendios forestales se abordan desde la visi√≥n STEM.
            </div>
          </div>
        `;

                program = document.getElementById("program");
                workspace = document.getElementById("workspace");
                colLabels = document.getElementById("col-labels");
                rowLabels = document.getElementById("row-labels");
                statusDiv = document.getElementById("status");
                batteryBar = document.getElementById("battery-bar");
                contenidoSTEM = document.getElementById("contenidoSTEM");
                vidasDiv = document.getElementById("vidas");

                document.getElementById('run-sim-program').onclick = runProgram;
                document.getElementById('delete-last-block').onclick = deleteLastBlock;
                document.getElementById('clear-program').onclick = clearProgram;
                document.getElementById('reset-board').onclick = reiniciarTablero;

                document.querySelectorAll("#sim-panel-left .block").forEach(b => {
                    b.addEventListener("dragstart", e => {
                        e.dataTransfer.setData("text", e.target.innerText);
                    });
                });
            }

            window.mostrarTema = function (t) {
                if (contenidoSTEM) contenidoSTEM.innerHTML = temas[t];
            }

            function generateGrid() {
                if (isSimRunning) return;

                gridSize = 10;
                let lakes = [[3, 4], [5, 9]];
                let fires = [[8, 5], [2, 7]];
                totalFires = fires.length;

                if (!workspace) {
                    console.error("Workspace no encontrado. Renderizando simulador.");
                    renderFunctionalSimulator();
                }

                workspace.innerHTML = "";
                colLabels.innerHTML = "";
                rowLabels.innerHTML = "";

                workspace.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                workspace.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;
                colLabels.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                rowLabels.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;

                for (let c = 1; c <= gridSize; c++) {
                    let label = document.createElement("div");
                    label.textContent = c;
                    colLabels.appendChild(label);
                }
                for (let r = 1; r <= gridSize; r++) {
                    let label = document.createElement("div");
                    label.textContent = r;
                    rowLabels.appendChild(label);
                }
                for (let r = 1; r <= gridSize; r++) {
                    for (let c = 1; c <= gridSize; c++) {
                        const cell = document.createElement("div");
                        cell.className = "cell";
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        workspace.appendChild(cell);
                    }
                }
                droneRow = gridSize; droneCol = 2;
                placeInCell(droneRow, droneCol, "‚öôÔ∏è", "dron");
                lakes.forEach(([r, c]) => placeInCell(r, c, "üíß", "lake"));
                fires.forEach(([r, c]) => placeInCell(r, c, "üî•", "fire"));

                apagados = 0;
                statusDiv.innerText = "Incendios apagados: 0";
                bateria = 100; updateBattery();
                water = false;
                actualizarVidas();
            }

            function actualizarVidas() {
                if (vidasDiv) vidasDiv.innerText = `Bater√≠as restantes: ${vidas} | Bater√≠as agotadas: ${bateriasAgotadas}`;
            }

            function placeInCell(row, col, icon, cls) {
                const cell = getCell(row, col);
                if (cell) {
                    cell.textContent = icon;
                    cell.classList.add(cls);
                }
            }
            function getCell(row, col) {
                if (!workspace) return null;
                return workspace.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
            }

            window.drop = function (e) {
                e.preventDefault();
                const text = e.dataTransfer.getData("text");
                const clone = document.createElement("div");
                clone.className = "block";
                clone.innerText = text;
                clone.addEventListener("dblclick", () => clone.remove());
                if (program) program.appendChild(clone);
            }
            function deleteLastBlock() {
                if (!program) return;
                const blocks = program.querySelectorAll(".block");
                if (blocks.length > 0) blocks[blocks.length - 1].remove();
            }
            function clearProgram() {
                if (program) program.innerHTML = "Arrastra aqu√≠ tus bloques";
            }

            function reiniciarTablero() {
                vidas = 3;
                bateriasAgotadas = 0;
                generateGrid();
            }

            function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
            function updateBattery() {
                if (!batteryBar) return;
                batteryBar.style.width = bateria + "%";
                if (bateria > 30) batteryBar.style.background = "var(--accent-green)";
                else if (bateria > 0) batteryBar.style.background = "var(--secondary-yellow)";
                else batteryBar.style.background = "var(--accent-red)";
            }

            async function runProgram() {
                if (isSimRunning) return;
                isSimRunning = true;
                document.getElementById('run-sim-program').disabled = true;

                let blocks = Array.from(program.querySelectorAll(".block")).map(b => b.innerText);
                if (blocks[0] !== "Iniciar programa") {
                    alert("Debes iniciar con el bloque 'Iniciar programa'");
                    isSimRunning = false;
                    document.getElementById('run-sim-program').disabled = false;
                    return;
                }
                for (let i = 1; i < blocks.length; i++) {
                    if (bateria <= 0) {
                        if (await manejarBateriaAgotada()) {
                            isSimRunning = false;
                            document.getElementById('run-sim-program').disabled = false;
                            return;
                        }
                    }
                    i = await execute(blocks, i);
                    if (i === -1) {
                        isSimRunning = false;
                        document.getElementById('run-sim-program').disabled = false;
                        return;
                    }
                }
                isSimRunning = false;
                document.getElementById('run-sim-program').disabled = false;
            }

            async function execute(blocks, i) {
                let cmd = blocks[i];
                let currentCell = getCell(droneRow, droneCol);
                if (currentCell) {
                    currentCell.textContent = "";
                    currentCell.classList.remove("dron");
                }

                switch (cmd) {
                    case "Repetir":
                        let veces = parseInt(prompt("¬øCu√°ntas veces deseas repetir las siguientes instrucciones?"));
                        if (!isNaN(veces) && veces > 0) {
                            for (let r = 0; r < veces; r++) {
                                if (i + 1 < blocks.length) {
                                    i = await execute(blocks, i + 1);
                                    if (i === -1) return -1;
                                }
                                if (i + 2 < blocks.length) {
                                    i = await execute(blocks, i + 2);
                                    if (i === -1) return -1;
                                }
                            }
                            i = i + 2;
                        }
                        break;
                    case "Si hay fuego":
                        let fireCell = getCell(droneRow, droneCol);
                        if (fireCell && fireCell.classList.contains("fire") && water) {
                            // Busca el pr√≥ximo bloque "Descargar agua" para ejecutarlo
                            let nextDischarge = blocks.indexOf("Descargar agua", i);
                            if (nextDischarge !== -1) {
                                i = await execute(blocks, nextDischarge);
                                if (i === -1) return -1;
                            }
                        }
                        break;

                    // --- CORRECCI√ìN DE BUG ---
                    case "Avanzar":
                        if (droneCol < gridSize) droneCol++;
                        bateria -= 10;
                        break;
                    case "Girar derecha": // BUG CORREGIDO
                        if (droneCol < gridSize) droneCol++; // Movimiento a√±adido
                        bateria -= 10; // Costo corregido
                        break;
                    case "Girar izquierda": // BUG CORREGIDO
                        if (droneCol > 1) droneCol--; // Movimiento a√±adido
                        bateria -= 10; // Costo corregido
                        break;
                    // --- FIN DE CORRECCI√ìN ---

                    case "Subir":
                        if (droneRow > 1) droneRow--;
                        bateria -= 10;
                        break;
                    case "Bajar":
                        if (droneRow < gridSize) droneRow++;
                        bateria -= 10;
                        break;

                    case "Recoger agua":
                        let lake = getCell(droneRow, droneCol);
                        if (lake && lake.classList.contains("lake")) { water = true; bateria = 100; }
                        break;
                    case "Descargar agua":
                        let fire = getCell(droneRow, droneCol);
                        if (water && fire && fire.classList.contains("fire")) {
                            fire.textContent = "‚úÖ";
                            fire.classList.remove("fire");
                            fire.classList.add("apagado");
                            apagados++;
                            statusDiv.innerText = "Incendios apagados: " + apagados;
                            water = false;

                            if (apagados === totalFires) {
                                transitionToView('results-view', {
                                    success: true,
                                    apagados: apagados,
                                    bateriasAgotadas: bateriasAgotadas
                                });
                                return -1; // Se√±al de fin
                            }
                        }
                        break;
                }

                // Volver a colocar el dron despu√©s de la acci√≥n
                let newCell = getCell(droneRow, droneCol);
                if (newCell && newCell.classList.contains("lake")) {
                    placeInCell(droneRow, droneCol, "üíß", "dron");
                } else if (newCell && newCell.classList.contains("fire")) {
                    placeInCell(droneRow, droneCol, "üî•", "dron");
                } else {
                    placeInCell(droneRow, droneCol, "‚öôÔ∏è", "dron");
                }

                if (bateria < 0) bateria = 0;
                updateBattery();
                await sleep(400);

                if (bateria === 0) {
                    if (await manejarBateriaAgotada()) {
                        return -1; // Se√±al de fin
                    }
                }
                return i;
            }

            async function manejarBateriaAgotada() {
                bateriasAgotadas++;
                vidas--;
                actualizarVidas();
                alert("‚ö†Ô∏è La bater√≠a se agot√≥. Pierdes una vida.");

                if (vidas <= 0) {
                    alert("‚ùå Has agotado las 3 bater√≠as. Misi√≥n fallida.");
                    transitionToView('results-view', {
                        success: false,
                        apagados: apagados,
                        bateriasAgotadas: bateriasAgotadas
                    });
                    return true;
                } else {
                    bateria = 100;
                    updateBattery();
                    return false;
                }
            }


            // ---------------------------
            // FASE 3: INFORME DE RESULTADOS (Corregido y A√±adido)
            // ---------------------------
            function showFinalResults(data) {
                const { success, apagados, bateriasAgotadas } = data;
                const view = document.getElementById('results-view');

                let conclusionText = '';
                if (success) {
                    conclusionText = 'Tu estrategia de programaci√≥n fue exitosa. Lograste neutralizar todos los focos de incendio optimizando el uso de la bater√≠a. ¬°Excelente trabajo de planeaci√≥n!';
                } else {
                    conclusionText = `La misi√≥n no pudo completarse. Es necesario revisar la secuencia de comandos y la estrategia de recarga para optimizar la ruta y el consumo de energ√≠a.`;
                }

                view.innerHTML = `
          <div class="results-card">
            <h2>INFORME FINAL DE MISI√ìN</h2>
            <p style="font-size:1.2em; color:${success ? 'var(--accent-green)' : 'var(--accent-red)'};"><strong>Resultado:</strong> ${success ? '√âXITO DE LA MISI√ìN' : 'MISI√ìN FALLIDA'}</p>
            <hr>

            <h3 style="color:var(--primary-blue);">An√°lisis de Rendimiento</h3>
            <div class="stat-result-box"><strong>Incendios Apagados:</strong> ${apagados} de ${totalFires}</div>
            <div class="stat-result-box"><strong>Bater√≠as Agotadas:</strong> ${bateriasAgotadas} (de 3 disponibles)</div>

            <h3 style="color:var(--primary-blue);">Conclusi√≥n T√©cnica</h3>
            <p>${conclusionText}</p>

            <div id="reflection-box">
                <h3 style="color:var(--secondary-yellow);">Diario de Misi√≥n (Reflexi√≥n Metacognitiva)</h3>
                <p style="font-size:0.9em;">Este es el espacio para la "reflexi√≥n" sobre la "acci√≥n". Responde: ¬øQu√© estrategia usaste? ¬øPor qu√© fall√≥ o tuvo √©xito? ¬øQu√© fue lo m√°s dif√≠cil? ¬øC√≥mo te sentiste al ver tu c√≥digo funcionar (o fallar)?</Girar>
                <textarea id="hypothesis-text" placeholder="Escribe aqu√≠ tu reflexi√≥n..."></textarea>
            </div>

            <button class="new-prototype-btn" onclick="location.reload()">Volver a Empezar (Briefing)</button>
          </div>
        `;
            }

            // Iniciar aplicaci√≥n mostrando el briefing
            transitionToView('briefing-view');

        }); // DOMContentLoaded end</script>

<!-- INICIO: Andamiaje Metacognitivo (Planifica ¬∑ Ajusta ¬∑ Eval√∫a) - Bot√≥n flotante -->
<style>
/* Metacognitive floating panel styles (no altera estilos existentes) */
#meta-fab{position:fixed; right:22px; bottom:22px; width:64px; height:64px; border-radius:50%; background:var(--primary-blue); color:#fff; font-size:1.9rem; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:1100; box-shadow:0 8px 24px rgba(0,0,0,0.4);}
#meta-panel{position:fixed; right:22px; bottom:100px; width:380px; max-width:95vw; height:540px; background:var(--panel-bg); border-radius:12px; display:none; flex-direction:column; z-index:1100; border:var(--border-soft); overflow:hidden;}
#meta-header{padding:12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.04); color:var(--text-light);}
#meta-tabs{display:flex; gap:6px; padding:10px; background:transparent;}
.meta-tab{flex:1; padding:8px; background:transparent; border-radius:8px; text-align:center; cursor:pointer; font-weight:700; color:var(--text-light); border:1px solid rgba(255,255,255,0.02);}
.meta-tab.active{background:linear-gradient(90deg,var(--primary-blue),var(--accent-green)); color:#042;}
.meta-body{padding:12px; overflow:auto; flex:1; color:var(--text-light);}
.input-small{width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text-light); margin-top:8px;}
.meta-actions{display:flex; gap:8px; margin-top:10px;}
.meta-btn{flex:1; padding:8px; border-radius:8px; border:none; cursor:pointer; font-weight:700;}
.meta-btn.primary{background:var(--primary-blue); color:#fff;}
.meta-btn.secondary{background:var(--accent-green); color:#042;}
.chat-area{max-height:160px; overflow:auto; display:flex; flex-direction:column; gap:8px; margin-top:8px;}
.msg{padding:8px; border-radius:8px; font-size:0.95rem;}
.msg.user{align-self:flex-end; background:rgba(0,173,181,0.12); color:var(--text-light);}
.msg.ai{align-self:flex-start; background:rgba(255,255,255,0.03); color:var(--text-light);}
.note-small{font-size:0.85rem; opacity:0.9; margin-top:6px;}
</style>

<button id="meta-fab" title="Andamiaje metacognitivo">üß©</button>

<div id="meta-panel" role="dialog" aria-hidden="true">
  <div id="meta-header">
    <strong>Planifica ¬∑ Ajusta ¬∑ Eval√∫a</strong>
    <button id="meta-close" class="meta-btn" style="background:none;color:var(--text-light);font-size:1.1rem;">‚úñ</button>
  </div>

  <div id="meta-tabs" role="tablist">
    <div class="meta-tab active" data-tab="plan">Planifica</div>
    <div class="meta-tab" data-tab="adjust">Ajusta</div>
    <div class="meta-tab" data-tab="eval">Eval√∫a</div>
  </div>

  <div class="meta-body">
    <div id="meta-plan" class="meta-tab-content">
      <div class="note-small">Antes de ejecutar: define objetivo, estrategia y predicci√≥n. Pide sugerencias al tutor si lo necesitas.</div>
      <input id="plan-objective" class="input-small" placeholder="Objetivo (ej. Apagar 2 incendios con ‚â§ 8 movimientos)"/>
      <textarea id="plan-strategy" class="input-small" rows="3" placeholder="Estrategia (ej. usar lagos como puntos de recarga)"></textarea>
      <input id="plan-prediction" class="input-small" placeholder="Predicci√≥n del resultado"/>
      <div class="meta-actions">
        <button id="plan-suggest" class="meta-btn primary">Sugerir </button>
        <button id="plan-save" class="meta-btn secondary">Guardar plan</button>
      </div>
      <div id="plan-suggestions" class="note-small" style="margin-top:8px;"></div>
    </div>

    <div id="meta-adjust" class="meta-tab-content" style="display:none;">
      <div class="note-small">Durante la simulaci√≥n puedes pedir pistas breves o feedback; la IA responde en lenguaje pedag√≥gico.</div>
      <div id="chat-area" class="chat-area"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="adjust-input" class="input-small" placeholder="Pregunta r√°pida..."/>
        <button id="adjust-send" class="meta-btn primary">Enviar</button>
      </div>
      <div style="margin-top:8px;">
        <button id="auto-hint" class="meta-btn" style="background:var(--secondary-yellow); color:#042; width:100%;">Pedir pista autom√°tica (al fallar)</button>
      </div>
    </div>

    <div id="meta-eval" class="meta-tab-content" style="display:none;">
      <div class="note-small">Despu√©s de la misi√≥n: solicita evaluaci√≥n autom√°tica y recomendaciones para mejorar.</div>
      <div id="eval-summary" class="note-small" style="background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; margin-top:8px;">Aqu√≠ aparecer√° el resumen post-ejecuci√≥n.</div>
      <div class="meta-actions">
        <button id="eval-gemini" class="meta-btn primary">Solicitar evaluaci√≥n</button>
        <button id="eval-fill" class="meta-btn secondary">Copiar resumen al informe</button>
      </div>
      <div id="eval-result" class="note-small" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<script>
/* === Metacognitive Gemini integration JS (no cambia variables existentes del simulador) ===
   - Solo necesita que pegues tu clave en GEMINI_API_KEY.
   - Las funciones son seguras: si no hay clave, muestran mensajes locales.
*/
(function(){
    const GEMINI_API_KEY = "AIzaSyAROaCa17Wo_OFzG15vZda5FCER3iTsoJg"; // <-- Pega aqu√≠ tu API key (ej: AIza...)
  const GEMINI_MODEL = "gemini-2.5-flash";

  // helpers
  const $ = id => document.getElementById(id);
  function appendChatMessage(text, who='ai'){
    const area = $('chat-area');
    if(!area) return;
    const d = document.createElement('div');
    d.className = 'msg ' + (who === 'user' ? 'user' : 'ai');
    d.innerText = text;
    area.appendChild(d);
    area.scrollTop = area.scrollHeight;
  }

  // simple Gemini caller (browser). Returns {text} or {error}
  async function callGemini(promptText){
    if(!GEMINI_API_KEY) return { error: 'Falta GEMINI_API_KEY' };
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    const body = { contents:[{ parts:[{ text: promptText }] }]};
    try{
      const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      if(!r.ok){
        const e = await r.json().catch(()=>null);
        return { error: e?.error?.message || r.statusText };
      }
      const data = await r.json();
      const txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(data);
      return { text: txt };
    }catch(err){ return { error: err.message }; }
  }

  // UI toggles
  const fab = document.getElementById('meta-fab');
  const panel = document.getElementById('meta-panel');
  const closeBtn = document.getElementById('meta-close');
  fab.addEventListener('click', ()=> panel.style.display = 'flex');
  closeBtn.addEventListener('click', ()=> panel.style.display = 'none');

  // tabs
  document.querySelectorAll('#meta-tabs .meta-tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('#meta-tabs .meta-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const name = tab.dataset.tab;
      document.querySelectorAll('.meta-tab-content').forEach(c=>c.style.display='none');
      document.getElementById('meta-' + name).style.display = 'block';
    });
  });

  // Planifica: suggest + save
  $('plan-suggest').addEventListener('click', async ()=>{
    const objective = $('plan-objective').value || 'Objetivo no especificado';
    const strategy = $('plan-strategy').value || 'Sin estrategia';
    const prediction = $('plan-prediction').value || 'Sin predicci√≥n';
    const prompt = `Eres un tutor pedag√≥gico y amable para estudiantes de secundaria. \
El estudiante propone este objetivo: "${objective}". Estrategia propuesta: "${strategy}". Predicci√≥n: "${prediction}". \
Ofrece 3 mejoras pr√°cticas, riesgos a considerar y 3 pasos concretos para optimizar el consumo de bater√≠a y la secuencia. Responde en espa√±ol, con frases cortas y claras.`;
    $('plan-suggestions').innerText = 'Consultando... Soacha territorio STEM+2025  ...';
    const res = await callGemini(prompt);
    if(res.error) $('plan-suggestions').innerText = 'Error: ' + res.error;
    else $('plan-suggestions').innerText = res.text;
  });

  $('plan-save').addEventListener('click', ()=>{
    const plan = {
      objective: $('plan-objective').value,
      strategy: $('plan-strategy').value,
      prediction: $('plan-prediction').value,
      hypothesis: document.querySelector('#hypothesis-box textarea') ? document.querySelector('#hypothesis-box textarea').value : ''
    };
    localStorage.setItem('dron_metaplan', JSON.stringify(plan));
    alert('Plan guardado localmente. ¬°Listo para simular!');
  });

  // Ajusta: chat quick
  $('adjust-send').addEventListener('click', async ()=>{
    const q = $('adjust-input').value.trim();
    if(!q) return;
    appendChatMessage(q, 'user');
    appendChatMessage('Pensando...', 'ai');
    $('adjust-input').value = '';
    const res = await callGemini(`Eres un tutor pedag√≥gico. Responde brevemente a esta pregunta de un estudiante: ${q}`);
    // remove the 'Pensando...' (last ai message)
    const area = $('chat-area');
    if(area && area.lastChild && area.lastChild.innerText === 'Pensando...') area.removeChild(area.lastChild);
    if(res.error) appendChatMessage('Error: ' + res.error, 'ai');
    else appendChatMessage(res.text, 'ai');
  });

  // Ajusta: auto-hint based on last run stats
  $('auto-hint').addEventListener('click', async ()=>{
    appendChatMessage('Solicitando pista autom√°tica...', 'user');
    appendChatMessage('Pensando...', 'ai');
    const stats = window.lastRunStats || { apagados:0, bateriasAgotadas:0, pasos:0, totalFires:0 };
    const prompt = `Act√∫a como tutor metacognitivo para un estudiante. Resultado de la corrida: incendios apagados ${stats.apagados}/${stats.totalFires}. \
Bater√≠as agotadas: ${stats.bateriasAgotadas}. Movimientos: ${stats.pasos}. \
Sugiere 3 ajustes concretos al programa (qu√© bloques cambiar o d√≥nde insertar recargas) y una estrategia corta para mejorar eficiencia. Responde en espa√±ol, tono pedag√≥gico y directo.`;
    const res = await callGemini(prompt);
    const area = $('chat-area');
    if(area && area.lastChild && area.lastChild.innerText === 'Pensando...') area.removeChild(area.lastChild);
    if(res.error) appendChatMessage('Error: ' + res.error, 'ai');
    else appendChatMessage(res.text, 'ai');
  });

  // Eval√∫a: request evaluation
  $('eval-gemini').addEventListener('click', async ()=>{
    $('eval-result').innerText = 'Generando evaluaci√≥n...';
    const stats = window.lastRunStats || { apagados:0, bateriasAgotadas:0, pasos:0, totalFires:0, success:false };
    const prompt = `Eres un evaluador docente amable. El estudiante consigui√≥ apagar ${stats.apagados} de ${stats.totalFires} incendios. \
Bater√≠as agotadas: ${stats.bateriasAgotadas}. Movimientos: ${stats.pasos}. \
Genera: (1) Logros observados en 2 frases. (2) 3 acciones concretas para mejorar. (3) Una recomendaci√≥n de tarea para practicar la pr√≥xima vez. Responde en espa√±ol, tono pedag√≥gico, claro y breve.`;
    const res = await callGemini(prompt);
    if(res.error) $('eval-result').innerText = 'Error: ' + res.error;
    else $('eval-result').innerText = res.text;
  });

  // Eval√∫a: copy to results reflection area (if exists)
  $('eval-fill').addEventListener('click', ()=>{
    const text = $('eval-result').innerText || '';
    // try to put into the reflection textarea in results-view (id may be hypothesis-text in that view)
    const reflection = document.querySelector('#reflection-box textarea') || document.querySelector('#hypothesis-text');
    if(reflection) reflection.value = text;
    alert('Resumen copiado al √°rea de reflexi√≥n (si existe).');
  });

  // optional: expose basic status in panel when results shown
  // Listen for showFinalResults being called by overriding it safely if present
  if(window.showFinalResults && typeof window.showFinalResults === 'function'){
    const origShow = window.showFinalResults;
    window.showFinalResults = function(data){
      try{
        // call original
        origShow(data);
      }catch(e){
        console.error('Error al ejecutar showFinalResults original', e);
      }finally{
        // fill eval-summary with stats for convenience
        const s = window.lastRunStats || { apagados: data?.apagados || 0, bateriasAgotadas: data?.bateriasAgotadas || 0, pasos: window.lastRunStats?.pasos || 0, totalFires: window.totalFires || 0, success: data?.success || false };
        const sum = `Incendios apagados: ${s.apagados}/${s.totalFires}. Bater√≠as agotadas: ${s.bateriasAgotadas}. Movimientos: ${s.pasos}.`;
        const el = document.getElementById('eval-summary');
        if(el) el.innerText = sum;
        // automatically open the panel to Eval√∫a
        document.querySelectorAll('#meta-tabs .meta-tab').forEach(t=>t.classList.remove('active'));
        const tabEval = document.querySelector('#meta-tabs .meta-tab[data-tab="eval"]');
        if(tabEval) tabEval.classList.add('active');
        document.querySelectorAll('.meta-tab-content').forEach(c=>c.style.display='none');
        const evalTab = document.getElementById('meta-eval');
        if(evalTab) evalTab.style.display = 'block';
        panel.style.display = 'flex';
      }
    };
  }

  // If no showFinalResults, provide a way to update lastRunStats externally
  window.metacog = window.metacog || {};
  window.metacog.updateStats = function(stats){ window.lastRunStats = stats; const el = document.getElementById('eval-summary'); if(el) el.innerText = `Incendios apagados: ${stats.apagados}/${stats.totalFires}. Bater√≠as agotadas: ${stats.bateriasAgotadas}. Movimientos: ${stats.pasos}.`; };

})(); // end IIFE
</script>
<!-- FIN: Andamiaje Metacognitivo -->


<!-- METACOG START -->
<!-- Andamiaje Metacognitivo Completo (modo directo con API local) -->
<style>
#metacog-toggle{position:fixed;right:20px;bottom:20px;z-index:9999;background:#1f2937;color:#fff;border:none;border-radius:50%;width:56px;height:56px;cursor:pointer;font-size:22px;box-shadow:0 6px 20px rgba(0,0,0,0.3)}
#metacog-panel{position:fixed;right:20px;bottom:90px;width:360px;max-width:calc(100% - 40px);z-index:9998;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.15);overflow:hidden;font-family:inherit}
#metacog-panel[hidden]{display:none}
#metacog-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #e5e7eb;background:#f9fafb}
#metacog-tabs{display:flex;gap:6px;padding:10px}
.metacog-tab{flex:1;padding:8px;border-radius:6px;background:#f3f4f6;text-align:center;cursor:pointer}
.metacog-tab[aria-selected="true"]{background:#111827;color:#fff}
.metacog-body{padding:12px;max-height:340px;overflow:auto}
.metacog-field{margin-bottom:10px}
.metacog-field label{font-weight:600;display:block;margin-bottom:4px}
.metacog-field textarea,.metacog-field input{width:100%;padding:8px;border-radius:6px;border:1px solid #d1d5db}
.metacog-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.metacog-btn{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
.metacog-small{font-size:12px;color:#6b7280}
</style>

<button id="metacog-toggle" title="Abrir Andamiaje Metacognitivo" aria-controls="metacog-panel" aria-expanded="false">üß©</button>

<div id="metacog-panel" role="dialog" aria-label="Andamiaje Metacognitivo" hidden>
  <div id="metacog-header">
    <strong>Planifica ¬∑ Ajusta ¬∑ Eval√∫a</strong>
    <button id="metacog-close" aria-label="Cerrar">‚úï</button>
  </div>
  <div id="metacog-tabs">
    <div class="metacog-tab" data-tab="plan" aria-selected="true">Planifica</div>
    <div class="metacog-tab" data-tab="adjust" aria-selected="false">Ajusta</div>
    <div class="metacog-tab" data-tab="eval" aria-selected="false">Eval√∫a</div>
  </div>
  <div class="metacog-body">
    <section id="metacog-plan">
      <div class="metacog-field">
        <label for="mc-goal">Objetivo</label>
        <input id="mc-goal" placeholder="¬øQu√© quieres lograr?">
      </div>
      <div class="metacog-field">
        <label for="mc-strategy">Estrategia</label>
        <textarea id="mc-strategy" rows="3" placeholder="Describe c√≥mo lo har√°s."></textarea>
      </div>
      <div class="metacog-field">
        <label for="mc-prediction">Predicci√≥n</label>
        <input id="mc-prediction" placeholder="¬øQu√© esperas que ocurra?">
      </div>
      <div class="metacog-buttons">
        <button class="metacog-btn" id="mc-suggest">Sugerir mejoras</button>
        <button class="metacog-btn" id="mc-save">Guardar</button>
        <button class="metacog-btn" id="mc-clear">Borrar</button>
      </div>
      <div id="mc-status" class="metacog-small"></div>
    </section>
    <section id="metacog-adjust" hidden>
      <div class="metacog-field">
        <label for="mc-question">Pregunta</label>
        <textarea id="mc-question" rows="3" placeholder="Haz una pregunta breve..."></textarea>
      </div>
      <div class="metacog-buttons">
        <button class="metacog-btn" id="mc-ask">Preguntar</button>
        <button class="metacog-btn" id="mc-hint">Pista autom√°tica</button>
      </div>
      <div class="metacog-field">
        <label for="mc-answer">Respuesta</label>
        <textarea id="mc-answer" rows="3" readonly></textarea>
      </div>
    </section>
    <section id="metacog-eval" hidden>
      <div class="metacog-field">
        <label for="mc-summary">Resumen de resultados</label>
        <textarea id="mc-summary" rows="3" readonly></textarea>
      </div>
      <div class="metacog-field">
        <label for="mc-eval">Autoevaluaci√≥n</label>
        <textarea id="mc-eval" rows="3" placeholder="¬øQu√© aprendiste? ¬øQu√© mejorar√≠as?"></textarea>
      </div>
      <div class="metacog-buttons">
        <button class="metacog-btn" id="mc-generate">Generar evaluaci√≥n</button>
        <button class="metacog-btn" id="mc-copy">Copiar al informe</button>
      </div>
      <div id="mc-eval-status" class="metacog-small"></div>
    </section>
  </div>
</div>

<script>
const GEMINI_API_KEY = ""; // Pega aqu√≠ tu API Key (modo directo)
const GEMINI_MODEL = "gemini-2.1";

function showTab(tab){
  document.querySelectorAll(".metacog-tab").forEach(t=>t.setAttribute("aria-selected",t.dataset.tab===tab));
  document.querySelectorAll("#metacog-panel section").forEach(s=>s.hidden = !s.id.includes(tab));
}

document.getElementById("metacog-toggle").onclick = ()=>{
  document.getElementById("metacog-panel").hidden=false;
  document.getElementById("metacog-toggle").setAttribute("aria-expanded","true");
};
document.getElementById("metacog-close").onclick = ()=>{
  document.getElementById("metacog-panel").hidden=true;
  document.getElementById("metacog-toggle").setAttribute("aria-expanded","false");
};
document.querySelectorAll(".metacog-tab").forEach(t=>t.onclick=()=>showTab(t.dataset.tab));

document.getElementById("mc-save").onclick = ()=>{
  const plan = {goal:mc-goal.value,strategy:mc-strategy.value,prediction:mc-prediction.value};
  localStorage.setItem("plan",JSON.stringify(plan));
  mc-status.textContent="Plan guardado.";
};
document.getElementById("mc-clear").onclick = ()=>{
  mc-goal.value=mc-strategy.value=mc-prediction.value="";
  mc-status.textContent="";
};

async function callGemini(prompt){
  if(!GEMINI_API_KEY) return "[SIMULACI√ìN] " + prompt.slice(0,100);
  const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt:{text:prompt}})
  });
  const d = await r.json();
  return d.candidates?.[0]?.content?.trim() || JSON.stringify(d);
}

document.getElementById("mc-suggest").onclick = async()=>{
  mc-status.textContent="Generando sugerencias...";
  const prompt=`Mejora este plan de aprendizaje:
Objetivo:${mc-goal.value}
Estrategia:${mc-strategy.value}`;
  mc-strategy.value+="

Sugerencias:
"+await callGemini(prompt);
  mc-status.textContent="Sugerencias a√±adidas.";
};

document.getElementById("mc-ask").onclick = async()=>{
  mc-answer.value="Pensando...";
  mc-answer.value=await callGemini(mc-question.value);
};

document.getElementById("mc-hint").onclick = async()=>{
  mc-answer.value=await callGemini("Genera una pista basada en el progreso del estudiante.");
};

document.getElementById("mc-generate").onclick = async()=>{
  mc-eval-status.textContent="Generando evaluaci√≥n...";
  mc-eval.value=await callGemini("Eval√∫a este trabajo:
"+mc-summary.value+"
Autoevaluaci√≥n:"+mc-eval.value);
  mc-eval-status.textContent="Evaluaci√≥n generada.";
};

document.getElementById("mc-copy").onclick = ()=>{
  const report=document.getElementById("final-report");
  if(report){report.value=mc-eval.value;mc-eval-status.textContent="Copiado al informe final.";}
  else{navigator.clipboard.writeText(mc-eval.value);mc-eval-status.textContent="Copiado al portapapeles.";}
};

window.metacog={updateStats:stats=>{
  document.getElementById("mc-summary").value=JSON.stringify(stats,null,2);
  document.getElementById("metacog-panel").hidden=false;
  showTab("eval");
}};
</script>
<!-- METACOG END -->

</body>
</html>